# GROUPE YAMA+ - Docker Compose Configuration
# Pour un d√©ploiement simple avec Docker

services:
  # MongoDB Database
  mongodb:
    image: mongo:6.0
    container_name: yama-mongodb
    restart: unless-stopped
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_DATABASE: yama_marketplace
    networks:
      - yama-network

  # Backend API (FastAPI)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: yama-backend
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      MONGO_URL: mongodb://mongodb:27017
      DB_NAME: yama_marketplace
      JWT_SECRET: ${JWT_SECRET:-your-secure-jwt-secret-change-this}
      SITE_URL: ${SITE_URL:-http://localhost}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
      MAILERSEND_API_KEY: ${MAILERSEND_API_KEY:-}
      PAYTECH_API_KEY: ${PAYTECH_API_KEY:-}
      PAYTECH_API_SECRET: ${PAYTECH_API_SECRET:-}
      PAYTECH_ENV: ${PAYTECH_ENV:-prod}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY:-}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY:-}
      VAPID_CLAIMS_EMAIL: ${VAPID_CLAIMS_EMAIL:-contact@yourdomain.com}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    depends_on:
      - mongodb
    networks:
      - yama-network
    volumes:
      - uploads_data:/app/uploads

  # Frontend (React Static Build served by Nginx)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_BACKEND_URL: ${SITE_URL:-http://localhost}
        REACT_APP_VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY:-}
    container_name: yama-frontend
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend
    networks:
      - yama-network
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro

volumes:
  mongodb_data:
  uploads_data:

networks:
  yama-network:
    driver: bridge
